# css重绘与回流（浏览器渲染机制）

## 浏览器渲染树

__HTTP__ 响应浏览器后（__HTML__、__CSS__ 和 __JavaScript__ 准备完毕）的普通渲染方式：然后，在 __DOM__ 树和 __CSS Object Model__ 上建立渲染树（__render tree__）：渲染树就是渲染时用到的树。渲染树其实就是 __DOM__ 树和 __CSS__ 的组合，和 __DOM__ 树相同的是每个 __HTML__ 标签对应一个渲染树节点，不同的是，文本节点比较特殊，每一行文本对应一个渲染树节点，并且，由于渲染树识别 __CSS__，```<head>``` 标签以及设置为 ```{display: none}``` 的标签不在 __DOM__ 树上。除此之外，渲染树上的每个节点该是什么样式也已经计算出来了，此时就涉及 __CSS__ 选择器的优先级了：浏览器默认样式<外部样式表< __style__ 内部样式表，同一样式表内部又有 __#id > .class > tagName > a:hover__，__important__ 的样式优先级最高。最后，渲染树建立之后，就可以在屏幕上开始绘制（__paint__）节点。

## 重绘和回流

当然这仅仅是第一次绘制，实际中会有交互行为，因此页面结构以及 __CSS__ 会随时变化，这就涉及到重绘（__repaint__）和回流（__reflow__）。回流是指渲染文档的结构被改变了，此时要重新布局了，导致回流的操作包括：
```bash
1.DOM元素的删改

2.表单或文本内容变化

3.CSS属性的更改或重新计算

4.修改class属性

5.浏览器窗口变化（滚动或缩放）

6.伪类激活

······（待补充）
```
重绘是指元素的样式改变不影响文档流整体结构时，渲染树结构也就没有变化，因此仅仅是重新显示样式。重绘的代价是比较小的。注意，这并不是说样式改变不会导致回流，只是特定样式改变，才不会导致回流。第二个需要注意的点是，回流一定需要重绘，但是重绘却不需要回流。
```bash
/*  以下Css Property改变  */

1.background-color

2.color

3.visibility

······（待补充）
```

## 浏览器优化策略

回流以及重绘会造成不必要的开销，这是浏览器要优化的问题之一，罪魁祸首就是 __JavaScript__ 代码执行时会改变 __DOM__ 树和 __CSS__ 样式，因此常见做法是缓存 __JavaScript__ 操作，然后通过一次回流或重绘解决几个操作的问题，当然也可以人为改变这一浏览器自主行为，方法就是通过获取元素属性迫使浏览器立即重绘和回流，为什么会这样呢？假设某一操作要读取元素的 __height__ 属性，此时浏览器已经缓存了几个操作，这些操作可能会改变 __height__ 值，而此时浏览器要返回当前的精确值，就不得不立即执行回流，否则是得不到这个精确值的。
```js
// 最终只有一次重绘和回流被触发
var $body = $('body');
$body.css('padding', '1px'); // 触发重绘与回流
$body.css('color', 'red'); // 触发重绘
$body.css('margin', '2px'); // 触发重绘与回流

//两次回流
var $body = $('body');
$body.css('padding', '1px');
$body.css('padding'); // 此处触发强制回流
$body.css('color', 'red');
$body.css('margin', '2px');
```
另一优化就是浏览器认为 __position__ 为 __absolute__ 或 __fixed__ 的元素更改只会影响其本身和子元素，而 __static__ 的元素变化则会影响之后的所有元素，具体请看[https://segmentfault.com/a/11](https://segmentfault.com/a/11)，原因在于 __absolute__ 和 __fixed__ 认为元素从文档流中清除了，怎么操作是内部的事。

## 开发优化策略

理解浏览器重绘以及回流的主要目的是为了优化开发，或许这些开销对浏览器不重要，但是了解了这些对一些优化实践就会有更深入的了解。   
比如：批量的 __DOM__ 操作可以通过复制 __DOM__ 节点，然后在复制的节点上进行一系列操作，再替换原节点即可，因为节点只要不加到 __DOM__ 树上就不影响渲染树，所以怎么折腾都没事，最后添加之后只执行一次回流。这就是“用 __innerHTML__ 代替 __DOM__ 操作，减少 __DOM__ 操作次数，优化 __Javascript__ 性能。”的原因。样式计算也是同样的道理。
```bash
(1)不要逐个修改CSS中的样式，每次修改可能都是一次重绘或回流，所以最好是在原始CSS里定义不同的class，通过改变class实现样式转换。

(2)只对position为absolue/fixed的元素设置动画，因为这些元素不在文档流中，怎么动都不会导致回流，只会重绘。

(3)当需要设置的样式很多时设置className而不是直接操作style。

(4)避免使用CSS Expression（css表达式)又称Dynamic properties(动态属性)。
```

摘自 [https://segmentfault.com/a/1190000008758227](https://segmentfault.com/a/1190000008758227)